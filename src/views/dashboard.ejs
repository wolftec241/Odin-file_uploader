<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dashboard</title>
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <script type="module">
        window.deleteFile = async function(fileId) {
    if (!confirm('Are you sure you want to delete this file?')) {
        return;
    }

    try {
        const response = await fetch(`/dashboard/file/${fileId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();

        if (result.success) {
            // Instead of just removing element, reload the page to update tree
            alert('File deleted successfully');
            window.location.reload(); // This keeps you on the same folder
        } else {
            alert('Error: ' + result.message);
        }
    } catch (err) { 
        console.error('Delete error:', err);
        alert('Failed to delete file');
    }
}

window.deleteFolder = async function(folderId) {
    if (!confirm('Are you sure you want to delete this folder and ALL its contents?')) {
        return;
    }
    
    try {
        const response = await fetch(`/dashboard/folder/${folderId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Folder deleted successfully');
            // Stay on current page or go to parent
            window.location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Delete error:', error);
        alert('Failed to delete folder');
    }
}
    </script>
</head>
<body>
    <header>
        <h1> Welcome to your Dashboard </h1>
        <a href="/logout">Logout</a>
    </header>

    <!-- Flash Messages -->
    <% if (error_msg && error_msg.length > 0) { %>
        <div class="notification error-notification">
            <%= error_msg %>
        </div>
    <% } %>
    <% if (success_msg && success_msg.length > 0) { %>
        <div class="notification success-notification">
            <%= success_msg %>
        </div>
    <% } %>
    
    <div class="navigation">
        <div><button onclick="toggleNewFolderForm()">My Folder</button></div>
        <div><button onclick="toggleNewFileForm()">New File</button></div>
        <%- include('partials/tree', { 
            rootFolder: rootFolder, 
            currentFolderId: currentFolderId,
            currentPath: currentPath 
        }) %>
    </div>

    <!-- overlay that darkens & blurs the background -->
    <div class="modal-overlay-for-new-folder" style="display: none;" onclick="toggleNewFolderForm()"></div>
    <div class="modal-overlay-for-new-file" style="display: none;" onclick="toggleNewFileForm()"></div>

    <div class="content">
    <div class="folder-header">
        <h2>üìÅ <%= correctFolder.name %></h2>
        <div class="action-buttons">
            <button onclick="toggleNewFolderForm()">New Folder</button>
            <button onclick="toggleNewFileForm()">Upload File</button>
        </div>
    </div>

    <% if (files.length == 0 && subFolders.length == 0) { %>
        <div class="empty-folder">
            <p>This folder is empty</p>
            <p>Upload files or create subfolders to get started</p>
        </div>
    <% } else { %>
        <!-- Folders section -->
        <% if (subFolders.length > 0) { %>
            <div class="folders-section">
                <h3>Folders</h3>
                <% subFolders.forEach(function(folder) { %>
                    <div class="file-item" data-folder-id="<%= folder.id %>">
                        <a href="/dashboard/<%= folder.id %>">üìÅ <%= folder.name %></a>
                        <button onclick="deleteFolder('<%= folder.id %>')">üóë</button>
                    </div>
                <% }); %>
            </div>
        <% } %>
        
        <!-- Files section -->
        <% if (files.length > 0) { %>
            <div class="files-section">
                <h3>Files</h3>
                <% files.forEach(function(file) { %>
                    <div class="file-item" data-file-id="<%= file.id %>">
                        <a href="/dashboard/download-file/<%= file.id %>">üìÑ <%= file.name %></a>
                        <span>(<%= (file.size / (1024 * 1024)).toFixed(2) %> MB)</span>
                        <button onclick="deleteFile('<%= file.id %>')">üóë</button>
                    </div>
                <% }); %>
            </div>
        <% } %>
    <% } %>
</div>

    <%- include('partials/newFolder', {correctFolderId: correctFolder.id }) %>
    <%- include('partials/newFile', {correctFolderId: correctFolder.id}) %>
</body>
</html>